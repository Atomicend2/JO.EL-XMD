//function _0x164e(_0x55d56f,_0xa8be13){const _0xd86012=_0xd860();return _0x164e=function(_0x164ef3,_0x5a89fd){_0x164ef3=_0x164ef3-0x18c;let _0x2f39f9=_0xd86012[_0x164ef3];return _0x2f39f9;},_0x164e(_0x55d56f,_0xa8be13);}(function(_0x1d4e67,_0x43c356){const _0x2ed620=_0x164e,_0x315bae=_0x1d4e67();while(!![]){try{const _0x28efe3=-parseInt(_0x2ed620(0x1bd))/0x1*(-parseInt(_0x2ed620(0x1a7))/0x2)+-parseInt(_0x2ed620(0x19f))/0x3+-parseInt(_0x2ed620(0x1b0))/0x4+parseInt(_0x2ed620(0x1ad))/0x5*(-parseInt(_0x2ed620(0x191))/0x6)+-parseInt(_0x2ed620(0x1b9))/0x7+parseInt(_0x2ed620(0x1b7))/0x8+parseInt(_0x2ed620(0x19a))/0x9*(parseInt(_0x2ed620(0x18f))/0xa);if(_0x28efe3===_0x43c356)break;else _0x315bae['push'](_0x315bae['shift']());}catch(_0x530752){_0x315bae['push'](_0x315bae['shift']());}}}(_0xd860,0x7978e));import{exec}from'child_process';import _0x5c6ceb from'axios';import _0xaf98be from'../../config.cjs';const updateCommand=async(_0x85363,_0x4bd484)=>{const _0x52069c=_0x164e,_0x1dc4fb=await _0x4bd484[_0x52069c(0x1a5)](_0x4bd484[_0x52069c(0x199)]['id']),_0x253395=[_0x1dc4fb,_0xaf98be[_0x52069c(0x1be)]+_0x52069c(0x197)][_0x52069c(0x1bf)](_0x85363[_0x52069c(0x196)]),_0x322e37=_0xaf98be[_0x52069c(0x1b2)],_0x1f6ca3=_0x85363['body'][_0x52069c(0x1ac)](_0x322e37)?_0x85363[_0x52069c(0x1af)][_0x52069c(0x1b6)](_0x322e37[_0x52069c(0x1a8)])['split']('\x20')[0x0]['toLowerCase']():'',_0x1d125f=_0x85363[_0x52069c(0x1af)][_0x52069c(0x1b6)](_0x322e37[_0x52069c(0x1a8)]+_0x1f6ca3['length'])['trim'](),_0x33dc1e='https://github.com/joeljamestech2/JOEL-XMD/joelXtec/joel.git',_0x2beacb=_0x52069c(0x1a6),_0x1e1b98=_0x52069c(0x1a9)+_0x2beacb,_0xaeaa8d=_0x52069c(0x19b),_0x3749cd=()=>{const _0x1cee81=_0x52069c;console['log'](_0x1cee81(0x19e)),exec(_0x1cee81(0x1b4),(_0x14d8a2,_0x1cc7a9,_0x35f85c)=>{const _0x1dbabc=_0x1cee81;_0x14d8a2?console[_0x1dbabc(0x1b3)](_0x1dbabc(0x1a4),_0x14d8a2):console[_0x1dbabc(0x18e)](_0x1dbabc(0x1a0));});};if(_0x1f6ca3===_0x52069c(0x1b5)){if(!_0x253395)return _0x85363[_0x52069c(0x1a3)](_0x52069c(0x195));try{const _0x3652df=await _0x5c6ceb[_0x52069c(0x1c0)](_0xaeaa8d),_0x164f3d=_0x3652df[_0x52069c(0x1ba)][_0x52069c(0x1a8)],_0x44cbf4=_0x3652df['data'][0x0][_0x52069c(0x1aa)];let _0x5a1b5f=_0x52069c(0x1a2)+_0x164f3d+_0x52069c(0x1a1)+_0x44cbf4;_0x85363[_0x52069c(0x1a3)](_0x5a1b5f);}catch(_0x1589e9){console[_0x52069c(0x1b3)](_0x52069c(0x192),_0x1589e9),_0x85363[_0x52069c(0x1a3)](_0x52069c(0x190));}}if(_0x1f6ca3==='updatenow'){if(!_0x253395)return _0x85363[_0x52069c(0x1a3)](_0x52069c(0x195));let _0x596263;exec(_0x52069c(0x19c)+_0x1e1b98,(_0x53c485,_0x9a17cf,_0x5c15d4)=>{const _0x179503=_0x52069c;if(_0x53c485){_0x596263=_0x179503(0x193),_0x85363['reply'](_0x596263);return;}else exec('cd\x20'+_0x1e1b98+_0x179503(0x1ae),(_0x3eb462,_0x5338ec,_0x3fcfe6)=>{const _0x23ba40=_0x179503;if(_0x3eb462){console['error'](_0x23ba40(0x1bb)+_0x3eb462),_0x596263='Failed\x20to\x20fetch\x20the\x20latest\x20changes.\x20Please\x20check\x20the\x20repo\x20path.',_0x85363[_0x23ba40(0x1a3)](_0x596263);return;}exec(_0x23ba40(0x18d)+_0x1e1b98+'\x20&&\x20git\x20log\x20origin/main\x20--oneline',(_0x4587db,_0x106770,_0x2eb330)=>{const _0x27b7db=_0x23ba40;if(_0x4587db){console[_0x27b7db(0x1b3)]('Log\x20error:\x20'+_0x4587db),_0x596263=_0x27b7db(0x18c),_0x85363[_0x27b7db(0x1a3)](_0x596263);return;}const _0x1cf7ca=_0x106770[_0x27b7db(0x194)]('\x0a')['map'](_0x5030ac=>_0x5030ac[_0x27b7db(0x1b8)]())[_0x27b7db(0x1ab)](Boolean),_0x3a035e=_0x1cf7ca[0x0]['split']('\x20')[0x0];exec(_0x27b7db(0x18d)+_0x1e1b98+_0x27b7db(0x198),(_0x2f0b90,_0x57b73e,_0x3de9e0)=>{const _0x3d2066=_0x27b7db;if(_0x2f0b90){console[_0x3d2066(0x1b3)](_0x3d2066(0x1bc)+_0x2f0b90),_0x596263='Failed\x20to\x20update\x20the\x20modified\x20files.',_0x85363['reply'](_0x596263);return;}console[_0x3d2066(0x18e)](_0x3d2066(0x1b1)+_0x57b73e),_0x596263='Updated\x20modified\x20files\x20successfully:\x0a'+_0x57b73e+_0x3d2066(0x19d),_0x85363[_0x3d2066(0x1a3)](_0x596263),_0x3749cd();});});});});}};export default updateCommand;function _0xd860(){const _0x125234=['data','Fetch\x20error:\x20','Checkout\x20error:\x20','5GFqkBi','OWNER_NUMBER','includes','get','Failed\x20to\x20fetch\x20commit\x20logs.','cd\x20','log','842530bxKRCH','Error\x20fetching\x20commits\x20count\x20from\x20GitHub.','1164qDQYIV','Error\x20fetching\x20commits:','Repository\x20not\x20found.\x20Please\x20clone\x20the\x20repo\x20first.','split','*\x20THIS\x20IS\x20AN\x20OWNER\x20COMMAND*','sender','@s.whatsapp.net','\x20&&\x20git\x20checkout\x20origin/main\x20--\x20.','user','153hjRYKU','https://api.github.com/repos/joeljamestech2/JOEL-XMD/commits','test\x20-d\x20','\x20please\x20restart\x20to\x20get\x20latest\x20updates\x20for\x20restart:\x20.restart','Restarting\x20bot...','831897pofzfp','Bot\x20restarted\x20successfully!','\x20commits.\x0aLatest\x20commit\x20SHA:\x20','The\x20GitHub\x20repository\x20has\x20','reply','Error\x20restarting\x20bot:','decodeJid','JOEL-XMD','277556EdJAYp','length','/home/container/','sha','filter','startsWith','16345JdXOcs','\x20&&\x20git\x20fetch\x20origin','body','2697316XNrDyV','Updated\x20modified\x20files\x20successfully:\x0a','PREFIX','error','pm2\x20restart\x20bot','update','slice','4336232rHiPWT','trim','4093992iHewxA'];_0xd860=function(){return _0x125234;};return _0xd860();}

import axios from "axios";
import fs from "fs";
import path from "path";
import { fileURLToPath } from 'url';
import AdmZip from "adm-zip";

// Get current directory path
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Import config
const configPath = path.join(__dirname, '../config.cjs');
const config = await import(configPath).then(m => m.default || m).catch(() => ({}));

const update = async (m, Matrix) => {
    const prefix = config.PREFIX || '.'; // Default prefix if not in config
    const cmd = m.body.startsWith(prefix)
        ? m.body.slice(prefix.length).split(" ")[0].toLowerCase()
        : "";

    if (cmd === "update") {
        // Only allow the bot itself to use this command
        const botNumber = await Matrix.decodeJid(Matrix.user.id);
        if (m.sender !== botNumber) {
            return Matrix.sendMessage(m.from, { text: "*Only Marisel can use this command!*" }, { quoted: m });
        }

        await m.React("‚è≥");

        try {
            console.log("Checking for updates...");
            const msg = await Matrix.sendMessage(m.from, { text: "```Checking for updates...```" }, { quoted: m });

            const editMessage = async (newText) => {
                try {
                    await Matrix.sendMessage(m.from, { text: newText, edit: msg.key });
                } catch (error) {
                    console.error("Message edit failed:", error);
                }
            };

            // Fetch latest commit hash
            const { data: commitData } = await axios.get(
                "https://api.github.com/repos/joeljamestech2/JOEL-XMD/commits/main"
            );
            const latestCommitHash = commitData.sha;

            // Load package.json
            const packageJsonPath = path.join(process.cwd(), "package.json");
            const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, "utf-8"));
            const currentHash = packageJson.commitHash || "unknown";

            if (latestCommitHash === currentHash) {
                await m.React("‚úÖ");
                return editMessage("```‚úÖ Bot is already up to date!```");
            }

            await editMessage("```New update found! Downloading...```");

            // Download latest ZIP
            const zipPath = path.join(process.cwd(), "latest.zip");
            const writer = fs.createWriteStream(zipPath);
            
            const response = await axios({
                method: 'get',
                url: "https://github.com/joeljamestech2/JOEL-XMD/archive/main.zip",
                responseType: 'stream'
            });

            response.data.pipe(writer);

            await new Promise((resolve, reject) => {
                writer.on('finish', resolve);
                writer.on('error', reject);
            });

            await editMessage("```Extracting the latest code...```");

            // Extract ZIP
            const extractPath = path.join(process.cwd(), "latest");
            const zip = new AdmZip(zipPath);
            zip.extractAllTo(extractPath, true);

            await editMessage("```üîÑ Replacing files...```");

            // Replace files while skipping important configs
            const sourcePath = path.join(extractPath, "JOEL-XMD-main");
            await copyFolderSync(sourcePath, process.cwd(), ['package.json', 'config.cjs', '.env']);

            // Update package.json with new commit hash
            packageJson.commitHash = latestCommitHash;
            fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2));

            // Cleanup
            fs.unlinkSync(zipPath);
            fs.rmSync(extractPath, { recursive: true, force: true });

            await editMessage("```‚ôªÔ∏è Restarting to apply updates...```");
            setTimeout(() => process.exit(0), 2000);

        } catch (error) {
            console.error("‚ùå Update error:", error);
            await m.React("‚ùå");
            await Matrix.sendMessage(m.from, 
                { text: `‚ùå Update failed:\n${error.message}` }, 
                { quoted: m }
            );
        }
    }
};

async function copyFolderSync(source, target, filesToSkip = []) {
    if (!fs.existsSync(target)) {
        fs.mkdirSync(target, { recursive: true });
    }

    const items = fs.readdirSync(source);
    for (const item of items) {
        const srcPath = path.join(source, item);
        const destPath = path.join(target, item);

        if (filesToSkip.includes(item)) continue;

        const stat = fs.lstatSync(srcPath);
        if (stat.isDirectory()) {
            await copyFolderSync(srcPath, destPath, filesToSkip);
        } else {
            fs.copyFileSync(srcPath, destPath);
        }
    }
}

export default update;
